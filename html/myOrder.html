<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Orders</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Font Awesome -->
<link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.0/css/all.min.css" rel="stylesheet">

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<link rel="stylesheet" href="../css/dashboard.css">
</head>

<body>

<nav class="navbar navbar-expand-lg bg-white border-bottom py-3">
  <div class="container">

    <!-- Logo -->
    <a class="navbar-brand fw-bold text-black fs-4" href="../index.html">
      Shopping
    </a>

    <!-- Toggler -->
    <button class="navbar-toggler" type="button"
            data-bs-toggle="collapse"
            data-bs-target="#mainNavbar"
            aria-controls="mainNavbar"
            aria-expanded="false"
            aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <!-- Links -->
    <div class="collapse navbar-collapse" id="mainNavbar">
      <ul class="navbar-nav ms-auto align-items-lg-center gap-lg-3 text-center text-lg-start">

        <li class="nav-item">
          <a class="nav-link" href="../index.html">Home</a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="../html/products.html">Products</a>
        </li>

        <li class="nav-item">
          <a class="nav-link cart-link position-relative" href="../html/cart.html">
            Cart <i class="fa-solid fa-cart-shopping"></i>
            <span class="cart-count badge bg-dark rounded-pill ms-1">0</span>
          </a>
        </li>

        <li class="nav-item">
          <a class="nav-link active fw-bold" href="../html/ordered_page.html">
            My Orders
          </a>
        </li>

      </ul>
    </div>

  </div>
</nav>

<div class="container my-5">
  <h3 class="fw-bold text-primary mb-4">My Orders</h3>
  <div id="ordersContainer"></div>
</div>

<script>
const container = document.getElementById("ordersContainer");
const user = JSON.parse(localStorage.getItem("user"));

// لو مش مسجل دخول
if (!user) {
  alert("You must login first!");
  window.location.href = "../html/login.html";
}

// نجيب أوردرات اليوزر بس
fetch(`http://localhost:3000/orders?userId=${user.id}`)
  .then(res => res.json())
  .then(data => {
    container.innerHTML = "";

    if (!data || data.length === 0) {
      container.innerHTML = `
        <div class="text-center py-5">
          <i class="fa-solid fa-box-open fa-5x text-secondary mb-3"></i>
          <h4 class="text-muted">You have no orders yet</h4>
          <a href="../html/products.html" class="btn btn-dark mt-3">
            Start Shopping
          </a>
        </div>
      `;
      return;
    }

    data.forEach(order => {
      let productList = order.products || order.items || [];
      let total = 0;

      const card = document.createElement("div");
      card.className = "border rounded p-4 mb-4 shadow-sm";

      // Header
      const headerDiv = document.createElement("div");
      headerDiv.className = "d-flex justify-content-between align-items-center mb-2";

      const strong = document.createElement("strong");
      strong.textContent = `Order #${order.id}`;

      const badge = document.createElement("span");
      const status = (order.status || "PENDING").toUpperCase();

      if (status === "COMPLETED") {
        badge.className = "badge bg-success";
      } 
      else if (status === "REJECTED") {
        badge.className = "badge bg-danger";
      } 
      else {
        badge.className = "badge bg-warning";
      }

      badge.textContent = status;

      headerDiv.appendChild(strong);
      headerDiv.appendChild(badge);

      // Products
      const productsDiv = document.createElement("div");

      productList.forEach(p => {
        const qty = p.quantity || p.qty || 1;
        const price = p.price || 0;
        total += price * qty;

        const itemDiv = document.createElement("div");
        itemDiv.className = "d-flex justify-content-between";

        itemDiv.innerHTML = `
          <span>${p.title || p.name} x ${qty}</span>
          <span>$${(price * qty).toFixed(2)}</span>
        `;

        productsDiv.appendChild(itemDiv);
      });

      // Total
      const totalDiv = document.createElement("div");
      totalDiv.className = "d-flex justify-content-between fw-bold mt-3";

      totalDiv.innerHTML = `
        <span>Total:</span>
        <span>$${total.toFixed(2)}</span>
      `;

      card.appendChild(headerDiv);
      card.appendChild(productsDiv);
      card.appendChild(document.createElement("hr"));
      card.appendChild(totalDiv);

      container.appendChild(card);
    });
  })
  .catch(err => {
    console.error("Error fetching orders:", err);
    container.innerHTML = "<p>Error loading orders</p>";
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
