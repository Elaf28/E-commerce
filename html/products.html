<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Products</title>
    
  <!-- Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.0/css/all.min.css" rel="stylesheet">
     <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card-img-top {
            height: 200px;
            object-fit: cover;
        }
        .price-old {
            text-decoration: line-through;
            color: gray;
            margin-right: 5px;
        }
        .price-new {
            font-weight: bold;
            color: #dc3545; 
        }
        aside {
           position: sticky;
           top: 20px; 
        }

    </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg bg-white border-bottom py-3">
  <div class="container">

    <!-- Logo -->
    <a class="navbar-brand fw-bold text-black fs-4" href="../index.html">
      Shopping
    </a>

    <!-- Toggler Button -->
    <button class="navbar-toggler" type="button"
            data-bs-toggle="collapse"
            data-bs-target="#mainNavbar"
            aria-controls="mainNavbar"
            aria-expanded="false"
            aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <!-- Links -->
    <div class="collapse navbar-collapse" id="mainNavbar">
      <ul class="navbar-nav ms-auto align-items-lg-center gap-lg-3 text-center text-lg-start">

        <li class="nav-item">
          <a class="nav-link" href="../index.html">Home</a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="../html/products.html">Products</a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="#">Categories</a>
        </li>

        <li class="nav-item">
          <a class="nav-link cart-link position-relative" href="../html/cart.html">
            Cart <i class="fa-solid fa-cart-shopping"></i>
            <span class="cart-count badge bg-dark rounded-pill ms-1">0</span>
          </a>
        </li>

        <li class="nav-item">
          <a class="nav-link orders-link" href="../html/ordered_page.html">
            My Orders
          </a>
        </li>

      </ul>
    </div>

  </div>
</nav>

<div class="container my-5">
    <div class="row">
        <!-- Sidebar Filters -->
        <aside class="col-md-3 mb-4">
            <h5>Filters</h5>
            
            <div class="mb-3">
                <label for="searchInput" class="form-label">Search Product</label>
                <input type="text" id="searchInput" class="form-control" placeholder="Search by name">
            </div>

            <div class="mb-3">
                <h6>Category</h6>
                <div id="categoryFilters">
                    <!-- الكاتيجري هتظهر هنا ديناميك -->
                </div>
            </div>

            <div class="mb-3">
                <h6>Rating</h6>
                <select id="ratingFilter" class="form-select">
                    <option value="">All Ratings</option>
                    <option value="high">Highest Rated</option>
                    <option value="low">Lowest Rated</option>
                    <option value="avg">Average</option>
                </select>
            </div>

            <div class="mb-3">
                <h6>Price</h6>
                <input type="number" id="minPrice" class="form-control mb-2" placeholder="Min Price">
                <input type="number" id="maxPrice" class="form-control" placeholder="Max Price">
            </div>
        </aside>

        <!-- Products -->
        <div class="col-md-9">
            <h2 class="text-center mb-4" id="productsTitle">All Products</h2>
            <div class="row" id="products-container">
                <!-- المنتجات هتظهر هنا -->
            </div>
        </div>
    </div>
</div>

<!-- <script>
const apiURL = "http://localhost:3000/products";
const productsContainer = document.getElementById("products-container");
const searchInput = document.getElementById("searchInput");
const categoryFilters = document.getElementById("categoryFilters");
const ratingFilter = document.getElementById("ratingFilter");
const minPriceInput = document.getElementById("minPrice");
const maxPriceInput = document.getElementById("maxPrice");
const productsTitle = document.getElementById("productsTitle");

let allProducts = [];
function addToCart(product) {
    const cartProduct = {
        id: product.id,
        title: product.title,
        price: product.price,
        quantity: 1,
        thumbnail: product.thumbnail
    };

    // POST إلى JSON Server
    fetch("http://localhost:3000/carts", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(cartProduct)
    })
    .then(res => res.json())
    .then(() => {
        updateCartCount(); // تحديث العداد
        alert(`${product.title} added to cart!`);
    })
    .catch(err => console.error(err));
}



// Fetch المنتجات
fetch(apiURL)
.then(res => res.json())
.then(products => {
    allProducts = products;

    // عرض الكاتيجري في الفيلتر
    const categories = [...new Set(products.map(p => p.category))];
    categoryFilters.innerHTML = categories.map(cat => `
        <div class="form-check">
            <input class="form-check-input" type="checkbox" value="${cat}" id="cat-${cat}">
            <label class="form-check-label" for="cat-${cat}">${cat}</label>
        </div>
    `).join("");

    // أضف event listeners للفلاتر مباشرة
    searchInput.addEventListener("input", applyFilters);
    categoryFilters.querySelectorAll("input").forEach(checkbox => {
        checkbox.addEventListener("change", applyFilters);
    });
    ratingFilter.addEventListener("change", applyFilters);
    minPriceInput.addEventListener("input", applyFilters);
    maxPriceInput.addEventListener("input", applyFilters);

    displayProducts(products);
});

// دالة العرض
function displayProducts(products){
    productsContainer.innerHTML = "";

    if(products.length === 0){
        productsContainer.innerHTML = "<p class='text-center'>No products found</p>";
        return;
    }

    products.forEach(product => {
        const imgSrc = product.thumbnail || 'https://via.placeholder.com/200';

        let priceHTML = `$${product.price.toFixed(2)}`;
        if(product.discountPercentage){
            const discountedPrice = (product.price * (1 - product.discountPercentage/100)).toFixed(2);
            priceHTML = `
                <span class="price-old">$${product.price.toFixed(2)}</span>
                <span class="price-new">$${discountedPrice}</span>
            `;
        }

        const col = document.createElement("div");
        col.className = "col-6 col-md-4 col-lg-3 mb-4";
        col.innerHTML = `
            <div class="card h-100">
                <a href="productDetails.html?id=${product.id}">
                    <img src="${imgSrc}" class="card-img-top">
                </a>
                <div class="card-body d-flex flex-column">
                    <h6>${product.title}</h6>
                    <p>${priceHTML}</p>
                    <button class="btn btn-dark mt-auto add-cart-btn">Add To Cart</button>
                </div>
            </div>
        `;

        // إضافة event listener للزر
        col.querySelector(".add-cart-btn").addEventListener("click", () => addToCart(product));

        productsContainer.appendChild(col);
    });
}


// فلترة المنتجات مباشرة
function applyFilters(){
    let filtered = allProducts;

    // Search
    const searchText = searchInput.value.toLowerCase();
    if(searchText) filtered = filtered.filter(p => p.title.toLowerCase().includes(searchText));

    // Category
    const selectedCats = Array.from(categoryFilters.querySelectorAll("input:checked")).map(input => input.value);
    if(selectedCats.length > 0) filtered = filtered.filter(p => selectedCats.includes(p.category));

    // Rating
    const ratingVal = ratingFilter.value;
    if(ratingVal){
        if(ratingVal === "high") filtered = filtered.sort((a,b) => b.rating - a.rating);
        else if(ratingVal === "low") filtered = filtered.sort((a,b) => a.rating - b.rating);
        else if(ratingVal === "avg") filtered = filtered.filter(p => p.rating >= 3 && p.rating <= 4);
    }

    // Price
    const minPrice = parseFloat(minPriceInput.value);
    const maxPrice = parseFloat(maxPriceInput.value);
    if(!isNaN(minPrice)) filtered = filtered.filter(p => p.price >= minPrice);
    if(!isNaN(maxPrice)) filtered = filtered.filter(p => p.price <= maxPrice);

    displayProducts(filtered);
}

</script> -->

<script>
const apiURL = "http://localhost:3000/products";
const productsContainer = document.getElementById("products-container");
const searchInput = document.getElementById("searchInput");
const categoryFilters = document.getElementById("categoryFilters");
const ratingFilter = document.getElementById("ratingFilter");
const minPriceInput = document.getElementById("minPrice");
const maxPriceInput = document.getElementById("maxPrice");
const productsTitle = document.getElementById("productsTitle");

let allProducts = [];

//  تحديث العداد 
async function updateCartCount(){
    const user = JSON.parse(localStorage.getItem("user"));
    if(!user) return;

    const res = await fetch(`http://localhost:3000/carts?userId=${user.id}`);
    const cart = await res.json();

    let total = 0;
    cart.forEach(item => total += item.quantity);

    document.querySelectorAll(".cart-count").forEach(el => el.textContent = total);
}

//  Add To Cart 
async function addToCart(product){
    const user = JSON.parse(localStorage.getItem("user"));
    if(!user){
        alert("Please login first!");
        return;
    }

    // تحقق لو المنتج موجود لنفس user
    const res = await fetch(`http://localhost:3000/carts?userId=${user.id}&productId=${product.id}`);
    const existing = await res.json();

    if(existing.length > 0){
        // زيادة الكمية
        await fetch(`http://localhost:3000/carts/${existing[0].id}`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ quantity: existing[0].quantity + 1 })
        });
    } else {
        // إضافة منتج جديد
        await fetch("http://localhost:3000/carts", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                userId: user.id,
                productId: product.id,
                title: product.title,
                price: product.price,
                image: product.thumbnail,
                quantity: 1
            })
        });
    }

    updateCartCount();
    alert(`${product.title} added to cart!`);
}

//  Fetch المنتجات 
fetch(apiURL)
.then(res => res.json())
.then(products => {
    allProducts = products;

    // عرض الكاتيجري في الفيلتر
    const categories = [...new Set(products.map(p => p.category))];
    categoryFilters.innerHTML = categories.map(cat => `
        <div class="form-check">
            <input class="form-check-input" type="checkbox" value="${cat}" id="cat-${cat}">
            <label class="form-check-label" for="cat-${cat}">${cat}</label>
        </div>
    `).join("");

    // أضف event listeners للفلاتر
    searchInput.addEventListener("input", applyFilters);
    categoryFilters.querySelectorAll("input").forEach(checkbox => {
        checkbox.addEventListener("change", applyFilters);
    });
    ratingFilter.addEventListener("change", applyFilters);
    minPriceInput.addEventListener("input", applyFilters);
    maxPriceInput.addEventListener("input", applyFilters);

    displayProducts(products);
});

//  دالة العرض 
function displayProducts(products){
    productsContainer.innerHTML = "";

    if(products.length === 0){
        productsContainer.innerHTML = "<p class='text-center'>No products found</p>";
        return;
    }

    products.forEach(product => {
        const imgSrc = product.thumbnail || 'https://via.placeholder.com/200';

        let priceHTML = `$${product.price.toFixed(2)}`;
        if(product.discountPercentage){
            const discountedPrice = (product.price * (1 - product.discountPercentage/100)).toFixed(2);
            priceHTML = `
                <span class="price-old">$${product.price.toFixed(2)}</span>
                <span class="price-new">$${discountedPrice}</span>
            `;
        }

        const col = document.createElement("div");
        col.className = "col-6 col-md-4 col-lg-3 mb-4";
        col.innerHTML = `
            <div class="card h-100">
                <a href="productDetails.html?id=${product.id}">
                    <img src="${imgSrc}" class="card-img-top">
                </a>
                <div class="card-body d-flex flex-column">
                    <h6>${product.title}</h6>
                    <p>${priceHTML}</p>
                    <button class="btn btn-dark mt-auto add-cart-btn">Add To Cart</button>
                </div>
            </div>
        `;

        // إضافة event listener للزر
        col.querySelector(".add-cart-btn").addEventListener("click", () => addToCart(product));

        productsContainer.appendChild(col);
    });
}

//  فلترة المنتجات 
function applyFilters(){
    let filtered = allProducts;

    // Search
    const searchText = searchInput.value.toLowerCase();
    if(searchText) filtered = filtered.filter(p => p.title.toLowerCase().includes(searchText));

    // Category
    const selectedCats = Array.from(categoryFilters.querySelectorAll("input:checked")).map(input => input.value);
    if(selectedCats.length > 0) filtered = filtered.filter(p => selectedCats.includes(p.category));

    // Rating
    const ratingVal = ratingFilter.value;
    if(ratingVal){
        if(ratingVal === "high") filtered = filtered.sort((a,b) => b.rating - a.rating);
        else if(ratingVal === "low") filtered = filtered.sort((a,b) => a.rating - b.rating);
        else if(ratingVal === "avg") filtered = filtered.filter(p => p.rating >= 3 && p.rating <= 4);
    }

    // Price
    const minPrice = parseFloat(minPriceInput.value);
    const maxPrice = parseFloat(maxPriceInput.value);
    if(!isNaN(minPrice)) filtered = filtered.filter(p => p.price >= minPrice);
    if(!isNaN(maxPrice)) filtered = filtered.filter(p => p.price <= maxPrice);

    displayProducts(filtered);
}

//  عند تحميل الصفحة 
document.addEventListener("DOMContentLoaded", updateCartCount);
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
<script src="../js/navbar.js"></script>
</body>
</html>
