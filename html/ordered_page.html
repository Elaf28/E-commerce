<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Orders</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg bg-white border-bottom py-3">
  <div class="container">
    <a class="navbar-brand fw-bold text-black fs-4" href="#">shopping</a>
    <div class="collapse navbar-collapse show">
      <ul class="navbar-nav ms-auto align-items-center gap-3" id="nav-links">
        <li class="nav-item"><a class="nav-link" href="#">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Products</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Categories</a></li>
        <li class="nav-item">
          <a class="nav-link" href="cart.html">
            Cart <i class="fa-solid fa-cart-shopping" id="cartLink"></i> <span class="cart-count">(0)</span>
          </a>
        </li>
        <li class="nav-item"><a id="myOrdersLink" class="nav-link" href="#">My Orders</a></li>
      </ul>
    </div>
  </div>
</nav>

<!-- Orders Page -->
<div class="container mt-5" id="ordersPage" style="display: none;">
  <h2>My Orders</h2>
  
  <!-- Search -->
  <div class="mb-3">
    <input type="text" id="searchInput" class="form-control" placeholder="Search orders...">
  </div>

  <!-- Orders Table -->
  <table class="table table-bordered">
    <thead>
      <tr>
        <th>Product Name</th>
        <th>Price</th>
        <th>Quantity</th>
        <th>Order Date</th>
        <th>Status</th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody id="ordersTableBody"></tbody>
  </table>
</div>

<script src="js/navbar.js"></script>
<script>
const ordersPage = document.getElementById('ordersPage');
const ordersTableBody = document.getElementById('ordersTableBody');
const myOrdersLink = document.getElementById('myOrdersLink');
const searchInput = document.getElementById('searchInput');

let orders = [];

// جلب المستخدم الحالي
function getCurrentUser() {
  return JSON.parse(localStorage.getItem("user"));
}

// فتح صفحة الطلبات عند الضغط على My Orders
myOrdersLink.addEventListener('click', () => {
  const user = getCurrentUser();
  if (!user) {
    alert("Please login to see your orders.");
    window.location.href = "login.html";
    return;
  }
  ordersPage.style.display = 'block';
  fetchOrders(user.id);
});

// جلب الطلبات من db.json حسب userId
function fetchOrders(userId) {
  fetch('http://localhost:3000/orders')
    .then(response => response.json())
    .then(data => {
      // فلتر الطلبات حسب المستخدم الحالي
      orders = data.filter(order => order.userId === userId);
      renderOrders(orders);
    })
    .catch(err => console.error('Error fetching orders:', err));
}

// دالة عرض الطلبات
function renderOrders(data) {
  ordersTableBody.innerHTML = "";

  data.forEach(order => {
    order.items.forEach(item => {
      const orderDate = new Date(order.date);
      const today = new Date();
      const diffTime = orderDate.getTime() - today.getTime();
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

      let statusText = "";
      if (order.status === "delivered") {
        statusText = "Delivered";
      } else if (order.status === "pending") {
        statusText = diffDays > 0 ? `${diffDays} day(s) left` : "Out for delivery";
      }

      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${item.title}</td>
        <td>$${item.price.toFixed(2)}</td>
        <td>${item.quantity}</td>
        <td>${orderDate.toLocaleDateString()}</td>
        <td>${statusText}</td>
        <td>$${(item.price * item.quantity).toFixed(2)}</td>
      `;
      ordersTableBody.appendChild(row);
    });
  });
}

// وظيفة البحث
searchInput.addEventListener('input', () => {
  const query = searchInput.value.toLowerCase();
  const filteredOrders = orders.filter(order =>
    order.items.some(item => item.title.toLowerCase().includes(query))
  );
  renderOrders(filteredOrders);
});
</script>
</body>
</html>
