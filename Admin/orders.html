<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Orders | Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="css/dashboard.css">

<style>
#sidebar{
    min-height:100vh;
    position:fixed;
    left:0;
    top:0;
}
</style>

</head>

<body>

<div class="container-fluid">
<div class="row">

    <!-- Sidebar -->
    <div id="sidebar" class="col-4 col-md-2 bg-dark text-white p-0">
        <div class="p-3">
            <h4>Admin Panel</h4>

            <ul class="nav flex-column">
                <li class="nav-item">
                    <a href="dashboard.html" class="nav-link text-white">Dashboard</a>
                </li>

                <li class="nav-item">
                    <a href="adminProducts.html" class="nav-link text-white">Products</a>
                </li>

                <li class="nav-item">
                    <a href="adminCategories.html" class="nav-link text-white">Categories</a>
                </li>

                <li class="nav-item">
                    <a href="orders.html" class="nav-link text-white">Orders</a>
                </li>

                <li class="nav-item mt-3">
                    <button class="btn btn-danger w-100" onclick="logout()">Logout</button>
                </li>
            </ul>
        </div>
    </div>

    <!-- Main Content -->
    <div class="col-md-10 offset-md-2 my-5">
        <h3 class="fw-bold mb-4">Orders Management</h3>
        <div id="ordersContainer"></div>
    </div>

</div>
</div>

<script>
const container = document.getElementById("ordersContainer");

fetch("http://localhost:3000/orders")
  .then(res => res.json())
  .then(data => {
    container.innerHTML = "";

    if (!data || data.length === 0) {
      container.innerHTML = "<p>No orders found</p>";
      return;
    }

    data.forEach(order => {
      let productList = order.products || order.items || [];
      let total = 0;

      const card = document.createElement("div");
      card.className = "border rounded p-4 mb-4 shadow-sm order-card";
      card.id = `order-${order.id}`;

      const productsDiv = document.createElement("div");
      productList.forEach(p => {
        const qty = p.quantity || p.qty || 1;
        const price = p.price || p.pricePerItem || 0;
        total += price * qty;

        const itemDiv = document.createElement("div");
        itemDiv.className = "d-flex justify-content-between";
        itemDiv.innerHTML =
          `<span>${p.title || p.name} x ${qty}</span>
           <span>$${(price * qty).toFixed(2)}</span>`;
        productsDiv.appendChild(itemDiv);
      });

      const headerDiv = document.createElement("div");
      headerDiv.className = "d-flex justify-content-between align-items-center mb-2";

      const strong = document.createElement("strong");
      strong.textContent = `Order #${order.id}`;

      const badge = document.createElement("span");
      badge.textContent = order.status || "PENDING";

      headerDiv.appendChild(strong);
      headerDiv.appendChild(badge);

      const totalDiv = document.createElement("div");
      totalDiv.className = "d-flex justify-content-between fw-bold mt-2";
      totalDiv.innerHTML =
        `<span>Total:</span><span>$${total.toFixed(2)}</span>`;

      const buttonsDiv = document.createElement("div");
      buttonsDiv.className = "mt-3 d-flex gap-2 order-buttons";

      const confirmBtn = document.createElement("button");
      confirmBtn.className = "btn btn-success btn-sm";
      confirmBtn.textContent = "Confirm";

      const rejectBtn = document.createElement("button");
      rejectBtn.className = "btn btn-danger btn-sm";
      rejectBtn.textContent = "Reject";

      buttonsDiv.appendChild(confirmBtn);
      buttonsDiv.appendChild(rejectBtn);

      const statusUpper = (order.status || "PENDING").toUpperCase();

      if (statusUpper === "COMPLETED") {
        badge.className = "badge bg-success";
        buttonsDiv.style.display = "none";
      } 
      else if (statusUpper === "REJECTED") {
        badge.className = "badge bg-danger";
        buttonsDiv.style.display = "none";
      } 
      else {
        badge.className = "badge bg-warning";

        confirmBtn.onclick = () =>
          updateOrderStatus(order.id,"COMPLETED",badge,buttonsDiv);

        rejectBtn.onclick = () =>
          updateOrderStatus(order.id,"REJECTED",badge,buttonsDiv);
      }

      card.appendChild(headerDiv);
      card.appendChild(productsDiv);
      card.appendChild(document.createElement("hr"));
      card.appendChild(totalDiv);
      card.appendChild(buttonsDiv);

      container.appendChild(card);
    });
  });

function updateOrderStatus(id,status,badge,buttonsDiv){
  fetch(`http://localhost:3000/orders/${id}`,{
    method:"PATCH",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({status})
  })
  .then(()=> {
    badge.textContent = status;
    badge.className =
      status==="COMPLETED"
      ? "badge bg-success"
      : "badge bg-danger";

    buttonsDiv.style.display = "none";
  })
}
</script>
<script src="sidebar.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
